<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>ACCESO</title>

    <!-- Favicon -->
    <link rel="icon" href="images.ico" type="image/x-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&subset=latin,cyrillic-ext" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Bootstrap Core Css -->
    <link href="plugins/bootstrap/css/bootstrap.css" rel="stylesheet">

    <!-- Waves Effect Css -->
    <link href="plugins/node-waves/waves.css" rel="stylesheet" />

    <!-- Animation Css -->
    <link href="plugins/animate-css/animate.css" rel="stylesheet" />

    <!-- Custom Css -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body class="login-page">

<div class="login-box">
    <div class="logo">
        <a href="javascript:void(0);">AUTOPROCESOS</a>
        <small>Sistema de Gestión de Compras, Servicios y Ventas</small>
    </div>

    <div class="card">
        <div class="body">
            <div class="msg">Ingrese sus credenciales</div>

            <div class="input-group">
                <span class="input-group-addon">
                    <i class="material-icons">person</i>
                </span>
                <div class="form-line">
                    <input type="text" class="form-control" id="login" placeholder="Usuario" required autofocus>
                </div>
            </div>

            <div class="input-group">
                <span class="input-group-addon">
                    <i class="material-icons">lock</i>
                </span>
                <div class="form-line">
                    <input type="password" class="form-control" id="password" placeholder="Contraseña" required>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-7">
                    <button class="btn btn-block bg-pink waves-effect"
                        type="button"
                        onclick="validarUsuario();">
                        INICIAR SESIÓN
                    </button>
                </div>
            </div>

            <div class="row m-t-15">
                <div class="col-xs-6">
                    <a href="#" data-toggle="modal" data-target="#registerModal">Registrarse</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL REGISTRO ================= -->
<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-black">
                <h4 class="modal-title">Registro de Usuario</h4>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="name" class="form-control">
                </div>

                <div class="form-group">
                    <label>Correo</label>
                    <input type="email" id="email" class="form-control">
                </div>

                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="login1" class="form-control">
                </div>

                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="password1" class="form-control">
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="registrarUsuario()">Registrar</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL 2FA ================= -->
<div class="modal fade" id="modal2fa" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-pink">
                <h4 class="modal-title">Verificación de Seguridad</h4>
            </div>
            <div class="modal-body">
                <p>Se envió un código de verificación a su correo.</p>

                <div class="form-group">
                    <label>Código</label>
                    <input type="text" id="code2fa" class="form-control" placeholder="Ingrese el código">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="verificarCodigo2FA()">Verificar</button>
            </div>
        </div>
    </div>
</div>

<!-- ================= JS ================= -->
<script src="plugins/jquery/jquery.min.js"></script>
<script src="plugins/bootstrap/js/bootstrap.js"></script>
<script src="plugins/node-waves/waves.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script src="js/ruta.js"></script>

<script>
    sessionStorage.clear();

    function validarUsuario() {

        $.ajax({
            url: getUrl() + "login",
            method: "POST",
            dataType: "json",
            data: {
                login: $("#login").val(),
                password: $("#password").val()
            }
        })
        .done(function (res) {

            if (res.tipo === '2fa') {
                sessionStorage.setItem('2fa_email', res.email);
                $("#modal2fa").modal("show");
                return;
            }

            sessionStorage.setItem('datosSesion', JSON.stringify(res));
            window.location = "menu.php";
        })
        .fail(function (e) {
            let r = JSON.parse(e.responseText);
            alert(r.message);
        });
    }

    function verificarCodigo2FA() {

        $.ajax({
            url: getUrl() + "2fa/email/validar",
            method: "POST",
            dataType: "json",
            data: {
                email: sessionStorage.getItem('2fa_email'),
                code: $("#code2fa").val()
            }
        })
        .done(function (res) {

            sessionStorage.setItem('datosSesion', JSON.stringify(res));
            $("#modal2fa").modal("hide");
            window.location = "menu.php";
        })
        .fail(function (e) {
            let r = JSON.parse(e.responseText);
            alert(r.mensaje);
        });
    }

    function registrarUsuario() {

        $.ajax({
            url: getUrl() + "registrarse",
            method: "POST",
            dataType: "json",
            data: {
                name: $("#name").val(),
                email: $("#email").val(),
                login: $("#login1").val(),
                password: $("#password1").val()
            }
        })
        .done(function () {
            Swal.fire("Registro exitoso", "Ya puede iniciar sesión", "success");
            $("#registerModal").modal("hide");
        })
        .fail(function (e) {
            alert("Error al registrar usuario");
        });
    }
</script>

</body>
</html>
